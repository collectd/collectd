---
name: Build
on:
  - push
  - pull_request

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: ubuntu-20.04
    env:
      MAKEFLAGS: "-j 2"
    steps:
    - uses: actions/checkout@v2
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          autotools-dev \
          libiptc-dev \
          libatasmart-dev \
          libcap-dev \
          libcurl4-gnutls-dev \
          libdbi0-dev \
          libesmtp-dev \
          libganglia1-dev \
          libgcrypt20-dev \
          libglib2.0-dev \
          libgps-dev \
          libhiredis-dev \
          libi2c-dev \
          libldap2-dev \
          libltdl-dev \
          liblua50-dev \
          liblua5.1-0-dev \
          liblua5.2-dev \
          libmemcached-dev \
          libmicrohttpd-dev \
          libmnl-dev \
          libmodbus-dev \
          libmosquitto-dev \
          libmysqlclient-dev \
          libnotify-dev \
          libopenipmi-dev \
          liboping-dev \
          libow-dev \
          libpcap-dev \
          libperl-dev \
          libpq-dev \
          libprotobuf-c-dev \
          librabbitmq-dev \
          librdkafka-dev \
          libriemann-client-dev \
          librrd-dev \
          libsensors4-dev \
          libsigrok-dev \
          libsnmp-dev \
          libtokyocabinet-dev \
          libtokyotyrant-dev \
          libudev-dev \
          libupsclient-dev \
          libvarnish-dev \
          libvirt-dev \
          libxen-dev \
          libxml2-dev \
          libyajl-dev \
          linux-libc-dev \
          perl \
          protobuf-c-compiler \
          python3-dev \
          python-dev \
          xfslibs-dev
    - run: type pkg-config
    - run: pkg-config --list-all | sort -u
    - name: Generate configure script
      run:
        ./build.sh
    - name: configure
      run: ./configure
    - name: make
      run: |
        make distcheck DISTCHECK_CONFIGURE_FLAGS="--disable-dependency-tracking --enable-debug"
